<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rider Tracker Pro</title>
    <link rel="manifest" href="data:application/manifest+json,{ %22name%22: %22Rider Tracker%22, %22short_name%22: %22Rider%22, %22start_url%22: %22.%22, %22display%22: %22standalone%22, %22background_color%22: %22%23121212%22, %22theme_color%22: %22%23121212%22, %22icons%22: [ { %22src%22: %22https://cdn-icons-png.flaticon.com/512/3198/3198336.png%22, %22sizes%22: %22512x512%22, %22type%22: %22image/png%22 } ] }">
    <style>
        body { background: #121212; color: #eee; font-family: sans-serif; margin: 0; padding: env(safe-area-inset-top) 10px 10px 10px; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        h3 { color: #00CCBC; margin: 0 0 10px 0; text-align: center; font-size: 14px; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; border-top: 1px solid #333; padding-top: 12px; margin-top: 15px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-add { background: #00CCBC; color: #000; }
        .btn-fuel { background: #ffa500; color: #000; }
        .btn-del { width: auto; padding: 6px 10px; background: #ff4444; color: white; font-size: 10px; border:none; border-radius:4px; }
        .stat-val { font-size: 15px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 9px; color: #aaa; text-transform: uppercase; }
        .target-box { background: #2a2a2a; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #555; }
        .session-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #00CCBC; font-size: 13px; position: relative; }
        .tag-netto { background: #00CCBC; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .scarto-label { color: #ff4444; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ðŸ“Š Riepilogo AttivitÃ </h3>
        <div class="grid">
            <div><span class="stat-label">Netto Reale (-Benza)</span><br><span id="nettoReale" class="stat-val">0.00</span> â‚¬</div>
            <div><span class="stat-label">Progresso</span><br><span id="progressoPerc" class="stat-val" style="color:#00CCBC">0%</span></div>
        </div>
        <div class="target-box">
            <label class="stat-label">ðŸŽ¯ TARGET NETTO (â‚¬)</label>
            <input type="number" id="targetInput" oninput="salvaTarget()" style="margin-top:5px; padding:8px;">
            <div style="margin-top:5px;">
                <span class="stat-label" style="color:#888">Lordo da fare:</span><br>
                <span id="lordoMancante" class="stat-val" style="color:#ff4444">0.00</span> <span class="stat-val">â‚¬</span>
            </div>
        </div>
        <div class="grid-triple">
            <div><span class="stat-label">Ore Lavoro</span><br><span id="oreTotali" class="stat-val">0.0</span></div>
            <div><span class="stat-label">Netto/Ora</span><br><span id="nettoOrario" class="stat-val" style="color:#00CCBC">0.00</span></div>
            <div><span class="stat-label">Media KM/L</span><br><span id="mediaKml" class="stat-val" style="color:#ffa500">0.0</span></div>
        </div>
    </div>

    <div class="card" style="border-color: #ffa50044;">
        <h3>â›½ Registra Rifornimento</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:10px;">
            <select id="fDay"></select>
            <select id="fMonth"></select>
            <select id="fYear"></select>
        </div>
        <div class="grid">
            <input type="number" id="fuelEuro" placeholder="Euro â‚¬">
            <input type="number" id="fuelPrezzo" step="0.001" placeholder="â‚¬/l">
        </div>
        <button class="btn-fuel" onclick="aggiungiBenza()">SALVA BENZINA</button>
    </div>

    <div class="card" style="border-color: #00ccbc44;">
        <h3>âž• Registra Sessione</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:10px;">
            <select id="sDay"></select>
            <select id="sMonth"></select>
            <select id="sYear"></select>
        </div>
        <div class="grid">
            <input type="number" id="sessKm" placeholder="Km Totali">
            <input type="number" id="sessScarto" placeholder="Scarto Km">
        </div>
        <div class="grid">
            <input type="number" id="sessLordo" step="0.01" placeholder="Lordo â‚¬">
            <input type="number" id="sessOre" step="0.1" placeholder="Ore Lavoro">
        </div>
        <input type="number" id="sessL100" step="0.1" placeholder="l/100 km (es. 4.0)">
        <button class="btn-add" onclick="aggiungiSessione()">SALVA SESSIONE</button>
    </div>

    <div id="storico"></div>
    <button onclick="resettutto()" style="background:#333; color:#888; padding:10px; font-size:10px; margin-top:20px;">RESET TUTTI I DATI</button>

    <script>
        let db = JSON.parse(localStorage.getItem('rider_pro_v25')) || { sessioni: [], rifornimenti: [], target: 500 };

        function popolaMenuDate() {
            const giorni = [document.getElementById('fDay'), document.getElementById('sDay')];
            const mesi = [document.getElementById('fMonth'), document.getElementById('sMonth')];
            const anni = [document.getElementById('fYear'), document.getElementById('sYear')];
            const d = new Date();

            giorni.forEach(sel => { for(let i=1; i<=31; i++) sel.innerHTML += `<option value="${i}" ${i==d.getDate()?'selected':''}>${i}</option>`; });
            mesi.forEach(sel => { for(let i=1; i<=12; i++) sel.innerHTML += `<option value="${i}" ${i==(d.getMonth()+1)?'selected':''}>${i}</option>`; });
            anni.forEach(sel => { for(let i=2025; i<=2040; i++) sel.innerHTML += `<option value="${i}">${i}</option>`; });
        }

        function salvaTarget() {
            db.target = parseFloat(document.getElementById('targetInput').value) || 0;
            salva();
        }

        function creaDataISO(prefix) {
            let gg = document.getElementById(prefix + 'Day').value.padStart(2, '0');
            let mm = document.getElementById(prefix + 'Month').value.padStart(2, '0');
            let aa = document.getElementById(prefix + 'Year').value;
            return aa + "-" + mm + "-" + gg;
        }

        function aggiungiBenza() {
            let data = creaDataISO('f');
            let e = parseFloat(document.getElementById('fuelEuro').value);
            let p = parseFloat(document.getElementById('fuelPrezzo').value);
            if(e > 0 && p > 0) {
                db.rifornimenti.push({ id: Date.now(), data, euro: e, prezzo: p });
                salva();
                document.getElementById('fuelEuro').value = "";
            }
        }

        function aggiungiSessione() {
            let data = creaDataISO('s');
            let km = parseFloat(document.getElementById('sessKm').value) || 0;
            let scarto = parseFloat(document.getElementById('sessScarto').value) || 0;
            let ore = parseFloat(document.getElementById('sessOre').value) || 0;
            let lordo = parseFloat(document.getElementById('sessLordo').value) || 0;
            let l100 = parseFloat(document.getElementById('sessL100').value) || 0;
            
            db.sessioni.push({ id: Date.now(), data, km, scarto, ore, lordo, l100 });
            salva();
            document.getElementById('sessKm').value = "";
            document.getElementById('sessScarto').value = "";
            document.getElementById('sessOre').value = "";
            document.getElementById('sessLordo').value = "";
            document.getElementById('sessL100').value = "";
        }

        function salva() {
            localStorage.setItem('rider_pro_v25', JSON.stringify(db));
            calcola();
        }

        function calcola() {
            let totLordo = db.sessioni.reduce((acc, s) => acc + s.lordo, 0);
            let totOre = db.sessioni.reduce((acc, s) => acc + s.ore, 0);
            let ultimoPrezzo = db.rifornimenti.length > 0 ? db.rifornimenti[db.rifornimenti.length-1].prezzo : 1.85;
            
            let costoBenzaStimato = db.sessioni.reduce((acc, s) => {
                let kmLavoro = Math.max(0, s.km - s.scarto);
                let litri = (kmLavoro / 100) * s.l100;
                return acc + (litri * ultimoPrezzo);
            }, 0);

            let nettoAttuale = (totLordo * 0.8) - costoBenzaStimato;
            let mancanoNetto = Math.max(0, db.target - nettoAttuale);
            
            let ultimaMediaKml = 0;
            if(db.sessioni.length > 0) {
                let ultimoL100 = db.sessioni[db.sessioni.length-1].l100;
                ultimaMediaKml = ultimoL100 > 0 ? (100 / ultimoL100) : 0;
            }

            document.getElementById('nettoReale').innerText = nettoAttuale.toFixed(2);
            document.getElementById('oreTotali').innerText = totOre.toFixed(1);
            document.getElementById('nettoOrario').innerText = totOre > 0 ? (nettoAttuale / totOre).toFixed(2) : "0.00";
            document.getElementById('mediaKml').innerText = ultimaMediaKml.toFixed(1);
            document.getElementById('progressoPerc').innerText = db.target > 0 ? Math.round((nettoAttuale / db.target) * 100) + "%" : "0%";
            document.getElementById('lordoMancante').innerText = (mancanoNetto * 1.25).toFixed(2);
            
            renderStorico(ultimoPrezzo);
        }

        function renderStorico(ultimoP) {
            let h = "<h3>ðŸ“œ Storico</h3>";
            let tutti = [...db.sessioni.map(s => ({...s, tipo: 'S'})), ...db.rifornimenti.map(r => ({...r, tipo: 'B'}))];
            tutti.sort((a,b) => new Date(a.data) - new Date(b.data)).reverse().forEach(item => {
                let p = item.data.split("-");
                let dIT = p[2] + "/" + p[1] + "/" + p[0];
                if(item.tipo === 'S') {
                    let kmLavoro = Math.max(0, item.km - item.scarto);
                    let litriSess = (kmLavoro / 100) * item.l100;
                    let nS = (item.lordo * 0.8) - (litriSess * ultimoP);
                    h += `<div class="session-item">
                        <span style="color:#888">${dIT}</span><br>
                        <b>Lordo: ${item.lordo.toFixed(2)}â‚¬</b> <span class="tag-netto">Netto: ${nS.toFixed(2)}â‚¬</span><br>
                        Km: ${item.km} | <span class="scarto-label">Scarto: ${item.scarto}</span> | Lav: <b>${kmLavoro}km</b><br>
                        <button class="btn-del" onclick="elimina('sessioni', ${item.id})" style="position:absolute; right:10px; top:12px;">X</button>
                    </div>`;
                } else {
                    h += `<div class="session-item" style="border-left-color: #ffa500; background: #2a2212;">
                        <span style="color:#888">${dIT}</span> | â›½ <b>RIFORNIMENTO ${item.euro.toFixed(2)}â‚¬</b>
                        <button class="btn-del" onclick="elimina('rifornimenti', ${item.id})" style="position:absolute; right:10px; top:12px;">X</button>
                    </div>`;
                }
            });
            document.getElementById('storico').innerHTML = h;
        }

        function elimina(tipo, id) { if(confirm("Eliminare?")) { db[tipo] = db[tipo].filter(item => item.id !== id); salva(); } }
        function resettutto() { if(confirm("Cancellare tutto?")) { localStorage.clear(); location.reload(); } }

        popolaMenuDate();
        document.getElementById('targetInput').value = db.target;
        calcola();
    </script>
</body>
</html>
