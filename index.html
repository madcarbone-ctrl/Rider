<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0f0f">
    <title>RIDER TRACKER PRO V1.0</title>
    <style>
        body { font-family: sans-serif; margin:0; padding:15px; }
        .btn-backup { padding:12px; border-radius:12px; font-weight:bold; border:none; margin:5px 0; width:100%; }
        .btn-save-backup { background:#00CCBC; }
        .btn-load-backup { background:#444; color:#fff; }
        .backup-list { font-size:12px; margin-top:10px; }
        .backup-item { border-bottom:1px solid #ccc; padding:6px 0; display:flex; justify-content:space-between; }
    </style>
</head>
<body>

<h2>REPORT ATTIVITÃ€</h2>
<div id="repTurniBody"></div>
<div id="repBenzaBody"></div>
<div id="repFinalSummary"></div>

<hr>
<h3>Backup dati</h3>

<button class="btn-backup btn-save-backup" onclick="salvaBackup()">ðŸ’¾ Salva backup</button>
<button class="btn-backup btn-load-backup" onclick="document.getElementById('fileBackup').click()">ðŸ“‚ Carica backup</button>
<input type="file" id="fileBackup" accept=".json" hidden>

<div class="backup-list" id="backupList"></div>
<script>
let db = JSON.parse(localStorage.getItem('rider_db_final_v30')) || { turni: [], rifornimenti: [], targets: {}, tax: 20 };
const BACKUP_KEY = "rider_backup_history";

function salvaBackup() {
    const data = { timestamp: Date.now(), app: "RIDER TRACKER PRO", versione: "1.0", db: db };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup_rider_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    salvaCronologiaBackup(data.timestamp);
    renderBackupList();
}

document.getElementById("fileBackup").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const json = JSON.parse(evt.target.result);
            if (!json.db) throw "Formato non valido";
            db = json.db;
            localStorage.setItem('rider_db_final_v30', JSON.stringify(db));
            alert("Backup caricato correttamente");
            location.reload();
        } catch {
            alert("File backup non valido");
        }
    };
    reader.readAsText(file);
});

function salvaCronologiaBackup(ts) {
    const list = JSON.parse(localStorage.getItem(BACKUP_KEY)) || [];
    list.unshift(ts);
    localStorage.setItem(BACKUP_KEY, JSON.stringify(list.slice(0,10)));
}

function renderBackupList() {
    const list = JSON.parse(localStorage.getItem(BACKUP_KEY)) || [];
    const box = document.getElementById("backupList");
    box.innerHTML = list.length ? "" : "Nessun backup salvato";
    list.forEach(ts => {
        const d = new Date(ts);
        const div = document.createElement("div");
        div.className = "backup-item";
        div.innerHTML = `<span>${d.toLocaleString()}</span>`;
        box.appendChild(div);
    });
}

renderBackupList();
</script>

</body>
</html>
