<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rider Tracker Pro</title>
    <style>
        body { background: #121212; color: #eee; font-family: sans-serif; margin: 0; padding: env(safe-area-inset-top) 8px 10px 8px; }
        .card { background: #1e1e1e; padding: 8px; border-radius: 12px; border: 1px solid #333; margin-bottom: 8px; }
        h3 { color: #00CCBC; margin: 0 0 8px 0; text-align: center; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .data-box { background: #252525; padding: 4px 2px; border-radius: 6px; border: 1px solid #333; text-align: center; min-height: 40px; display: flex; flex-direction: column; justify-content: center; }
        
        .stat-label { font-size: 7px; color: #aaa; text-transform: uppercase; font-weight: 600; margin-bottom: 1px; }
        .stat-val { font-size: 12px; font-weight: bold; color: #fff; line-height: 1.1; }

        input, select { width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 6px; box-sizing: border-box; font-size: 14px; -webkit-appearance: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        
        .progress-container { width: 100%; background: #1a1a1a; border-radius: 10px; height: 18px; margin: 6px 0; position: relative; overflow: hidden; border: 1px solid #333; }
        .progress-bar { 
            height: 100%; width: 0%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); 
            background: linear-gradient(90deg, #ff4444 0%, #ffa500 30%, #00CCBC 70%, #00ff88 100%);
            background-size: 100vw 100%;
        }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 900; color: #fff; text-shadow: 1px 1px 2px #000; }

        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 12px; }
        .btn-add { background: #00CCBC; color: #000; }
        .btn-fuel { background: #ffa500; color: #000; }
        .btn-del { width: auto; padding: 6px 10px; background: #ff4444; color: white; font-size: 10px; border:none; border-radius:6px; }
        
        .btn-reset-all { background: #8b0000; color: #ffcccc; margin-top: 20px; border: 1px solid #ff4444; }
        
        .target-box { background: #2a2a2a; padding: 8px; border-radius: 10px; margin-top: 8px; border: 1px solid #444; }
        .target-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .target-info { display: flex; justify-content: space-between; margin-top: 2px; align-items: center; min-height: 15px; }

        .blink-win { font-weight: 900; font-size: 10px; color: #00ff88; animation: blinker 0.8s linear infinite; display: none; }
        @keyframes blinker { 50% { opacity: 0.3; } }

        #toast { visibility: hidden; min-width: 180px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 10px; position: fixed; z-index: 1000; left: 50%; bottom: 20px; transform: translateX(-50%); border: 1px solid #00CCBC; font-size: 12px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 1.5s; }

        .session-item { background: #252525; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid #00CCBC; position: relative; font-size: 12px; line-height: 1.5; }
        .history-date { color: #888; font-size: 10px; font-weight: bold; margin-bottom: 4px; display: block; }
        .history-main { display: block; margin-bottom: 2px; }
        .history-sub { color: #bbb; font-size: 11px; }
        .tag-netto { background: #00CCBC; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: 5px; }

        .footer-credits { text-align: center; padding: 20px 10px 40px 10px; color: #444; font-size: 10px; letter-spacing: 0.5px; font-style: italic; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 20px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 20px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>
    <div id="toast"></div>
    <div class="card">
        <h3>üöÄ RIDER TRACKER</h3>
        
        <div class="summary-grid">
            <div class="data-box"><span class="stat-label">Lordo</span><span class="stat-val" style="color:#00CCBC">‚Ç¨ <span id="lordoTotale">0.00</span></span></div>
            <div class="data-box"><span class="stat-label">Netto</span><span class="stat-val">‚Ç¨ <span id="nettoReale">0.00</span></span></div>
            <div class="data-box"><span class="stat-label">Benza</span><span class="stat-val" style="color:#ff4444">‚Ç¨ <span id="costoBenzaTot">0.00</span></span></div>
            <div class="data-box"><span class="stat-label">Litri</span><span class="stat-val"><span id="litriTot">0.0</span> L</span></div>
            <div class="data-box"><span class="stat-label">KM Lav.</span><span id="kmLavoroTot" class="stat-val" style="color:#00CCBC">0</span></div>
            <div class="data-box"><span class="stat-label">KM Tot.</span><span id="kmAssoluti" class="stat-val" style="color:#ffa500">0</span></div>
            <div class="data-box"><span class="stat-label">Ore</span><span id="oreTotali" class="stat-val">0.0</span></div>
            <div class="data-box"><span class="stat-label">KM/L</span><span id="mediaKml" class="stat-val" style="color:#ffa500">0.0</span></div>
            <div class="data-box"><span class="stat-label">Netto/H</span><span class="stat-val" style="color:#00CCBC">‚Ç¨ <span id="nettoOrario">0.00</span></span></div>
        </div>

        <div class="target-box">
            <div class="target-row">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label class="stat-label" style="margin:0;">üéØ TARGET</label>
                    <input type="number" id="targetInput" oninput="salvaTarget()" placeholder="0" style="margin:0; width: 65px; height: 22px; padding: 2px 5px; font-size: 11px; text-align: center; border-color: #00CCBC;">
                </div>
                <div style="text-align: right;">
                    <span class="stat-label" style="display: block;">GIORNI LAVORATI</span>
                    <span id="giorniLavorati" class="stat-val" style="color:#00CCBC; font-size: 14px;">0</span>
                </div>
            </div>
            <div class="progress-container"><div id="pBar" class="progress-bar"></div><div id="progressoPerc" class="progress-text">0%</div></div>
            <div class="target-info">
                <div><span class="stat-label">Manca Lordo:</span> <span class="stat-val" style="color:#ff4444; font-size: 11px;">‚Ç¨ <span id="lordoMancante">0.00</span></span></div>
                <div id="winMsg" class="blink-win">OBIETTIVO RAGGIUNTO !</div>
            </div>
        </div>
    </div>

    <div class="card" style="border-color: #ffa50044; padding-bottom: 2px;">
        <h3 style="margin-bottom:4px; font-size: 9px;">‚õΩ Rifornimento</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:4px;"><select id="fDay"></select><select id="fMonth"></select><select id="fYear"></select></div>
        <div class="grid"><input type="number" id="fuelEuro" placeholder="Euro ‚Ç¨"><input type="number" id="fuelPrezzo" step="0.001" placeholder="‚Ç¨/l"></div>
        <button class="btn-fuel" onclick="aggiungiBenza()">SALVA RIFORNIMENTO</button>
    </div>

    <div class="card" style="border-color: #00ccbc44; padding-bottom: 2px;">
        <h3 style="margin-bottom:4px; font-size: 9px;">‚ûï Sessione</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:4px;"><select id="sDay"></select><select id="sMonth"></select><select id="sYear"></select></div>
        <div class="grid"><input type="number" id="sessKm" placeholder="Km Tot"><input type="number" id="sessScarto" placeholder="Scarto"></div>
        <div class="grid"><input type="number" id="sessLordo" step="0.01" placeholder="Lordo ‚Ç¨"><input type="number" id="sessOre" step="0.1" placeholder="Ore"></div>
        <input type="number" id="sessL100" step="0.1" placeholder="l/100 km">
        <button class="btn-add" onclick="aggiungiSessione()">SALVA SESSIONE</button>
    </div>

    <div id="storico"></div>

    <button class="btn-reset-all" onclick="resettutto()">‚ö†Ô∏è AZZERA TUTTA LA SCHERMATA</button>
    
    <div class="footer-credits">Rider Tracker V. 1.0</div>

    <script>
        let db = JSON.parse(localStorage.getItem('rider_pro_v61')) || { sessioni: [], rifornimenti: [], target: 0 };
        function showToast(msg) { let x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 2000); }
        
        function popolaMenuDate() {
            const d = new Date();
            const g = [document.getElementById('fDay'), document.getElementById('sDay')], m = [document.getElementById('fMonth'), document.getElementById('sMonth')], a = [document.getElementById('fYear'), document.getElementById('sYear')];
            g.forEach(s => { s.innerHTML = ""; for(let i=1; i<=31; i++) s.innerHTML += `<option value="${i}" ${i==d.getDate()?'selected':''}>${i}</option>`; });
            m.forEach(s => { s.innerHTML = ""; for(let i=1; i<=12; i++) s.innerHTML += `<option value="${i}" ${i==(d.getMonth()+1)?'selected':''}>${i}</option>`; });
            a.forEach(s => { s.innerHTML = ""; for(let i=2025; i<=2028; i++) s.innerHTML += `<option value="${i}" ${i==d.getFullYear()?'selected':''}>${i}</option>`; });
        }

        function salvaTarget() { db.target = parseFloat(document.getElementById('targetInput').value) || 0; salva(); }
        function creaDataISO(p) { return document.getElementById(p+'Year').value + "-" + document.getElementById(p+'Month').value.padStart(2,'0') + "-" + document.getElementById(p+'Day').value.padStart(2,'0'); }

        function aggiungiBenza() {
            let e = parseFloat(document.getElementById('fuelEuro').value), p = parseFloat(document.getElementById('fuelPrezzo').value);
            if(e > 0 && p > 0) { db.rifornimenti.push({ id: Date.now(), data: creaDataISO('f'), euro: e, prezzo: p }); salva(); document.getElementById('fuelEuro').value = ""; document.getElementById('fuelPrezzo').value = ""; showToast("‚úÖ Benzinata!"); }
        }

        function aggiungiSessione() {
            let km = parseFloat(document.getElementById('sessKm').value) || 0, s = parseFloat(document.getElementById('sessScarto').value) || 0, o = parseFloat(document.getElementById('sessOre').value) || 0, l = parseFloat(document.getElementById('sessLordo').value) || 0, c = parseFloat(document.getElementById('sessL100').value) || 0;
            if(l > 0 || km > 0) { 
                db.sessioni.push({ id: Date.now(), data: creaDataISO('s'), km, scarto: s, ore: o, lordo: l, l100: c }); 
                salva(); 
                document.getElementById('sessKm').value = ""; document.getElementById('sessScarto').value = ""; document.getElementById('sessOre').value = ""; document.getElementById('sessLordo').value = ""; document.getElementById('sessL100').value = "";
                showToast("‚úÖ Sessione Salvata!"); 
            }
        }

        function salva() { localStorage.setItem('rider_pro_v61', JSON.stringify(db)); calcola(); }

        function calcola() {
            let totL = db.sessioni.reduce((acc, s) => acc + s.lordo, 0), totO = db.sessioni.reduce((acc, s) => acc + s.ore, 0), uP = db.rifornimenti.length > 0 ? db.rifornimenti[db.rifornimenti.length-1].prezzo : 1.85;
            let kmAss = db.sessioni.reduce((acc, s) => acc + s.km, 0), kmLav = db.sessioni.reduce((acc, s) => acc + Math.max(0, s.km - s.scarto), 0);
            let gUnici = [...new Set(db.sessioni.map(s => s.data))].length;
            document.getElementById('giorniLavorati').innerText = gUnici;
            let litriT = 0, costoB = db.sessioni.reduce((acc, s) => { let k = Math.max(0, s.km - s.scarto); let lt = (k / 100) * s.l100; litriT += lt; return acc + (lt * uP); }, 0);
            let nA = (totL * 0.8) - costoB, mancN = Math.max(0, db.target - nA), perc = db.target > 0 ? Math.min(100, Math.round((nA / db.target) * 100)) : 0;
            document.getElementById('pBar').style.width = perc + "%"; document.getElementById('progressoPerc').innerText = perc + "%";
            document.getElementById('lordoTotale').innerText = totL.toFixed(2); document.getElementById('nettoReale').innerText = nA.toFixed(2);
            document.getElementById('costoBenzaTot').innerText = costoB.toFixed(2); document.getElementById('litriTot').innerText = litriT.toFixed(1);
            document.getElementById('kmAssoluti').innerText = kmAss; document.getElementById('kmLavoroTot').innerText = kmLav;
            document.getElementById('oreTotali').innerText = totO.toFixed(1); document.getElementById('nettoOrario').innerText = totO > 0 ? (nA / totO).toFixed(2) : "0.00";
            document.getElementById('mediaKml').innerText = db.sessioni.length > 0 && db.sessioni[db.sessioni.length-1].l100 > 0 ? (100 / db.sessioni[db.sessioni.length-1].l100).toFixed(1) : "0.0";
            document.getElementById('lordoMancante').innerText = (mancN * 1.25).toFixed(2); 
            document.getElementById('winMsg').style.display = (db.target > 0 && perc >= 100) ? "block" : "none";
            renderStorico(uP);
        }

        function renderStorico(uP) {
            let h = "<h3>üìú STORICO COMPLETO</h3>", tutti = [...db.sessioni.map(s => ({...s, tipo: 'S'})), ...db.rifornimenti.map(r => ({...r, tipo: 'B'}))];
            tutti.sort((a,b) => new Date(a.data) - new Date(b.data)).reverse().forEach(item => {
                let d = item.data.split("-"), dIT = d[2]+"/"+d[1]+"/"+d[0];
                if(item.tipo === 'S') {
                    let kmL = Math.max(0, item.km - item.scarto), nS = (item.lordo * 0.8) - ((kmL / 100) * item.l100 * uP);
                    h += `<div class="session-item"><span class="history-date">${dIT} - SESSIONE DI LAVORO</span>
                         <span class="history-main">Lordo: <b>‚Ç¨ ${item.lordo.toFixed(2)}</b> <span class="tag-netto">Netto: ‚Ç¨ ${nS.toFixed(2)}</span></span>
                         <span class="history-sub">Tempo: ${item.ore} Ore | Percorso: ${kmL} Chilometri</span>
                         <button class="btn-del" onclick="elimina('sessioni', ${item.id})" style="position:absolute; right:10px; top:25px;">ELIMINA</button></div>`;
                } else {
                    h += `<div class="session-item" style="border-left-color: #ffa500; background: #2a2212;"><span class="history-date">${dIT} - RIFORNIMENTO CARBURANTE</span>
                         <span class="history-main">Spesa: <b>‚Ç¨ ${item.euro.toFixed(2)}</b></span>
                         <span class="history-sub">Prezzo Carburante: ‚Ç¨ ${item.prezzo.toFixed(3)} / Litro</span>
                         <button class="btn-del" onclick="elimina('rifornimenti', ${item.id})" style="position:absolute; right:10px; top:15px;">ELIMINA</button></div>`;
                }
            });
            document.getElementById('storico').innerHTML = h;
        }

        function elimina(t, id) { if(confirm("Confermi di voler eliminare questa voce?")) { db[t] = db[t].filter(i => i.id !== id); salva(); } }
        
        function resettutto() { 
            let c1 = confirm("‚ö†Ô∏è ATTENZIONE: Questa azione canceller√† DEFINITIVAMENTE tutti i dati della schermata.");
            if(c1) {
                let c2 = confirm("Sei veramente sicuro di voler azzerare tutto?");
                if(c2) {
                    db = { sessioni: [], rifornimenti: [], target: 0 }; 
                    localStorage.removeItem('rider_pro_v61');
                    document.getElementById('targetInput').value = "";
                    document.querySelectorAll('input').forEach(i => i.value = "");
                    popolaMenuDate(); 
                    calcola();
                    showToast("üóëÔ∏è Tutto azzerato!");
                }
            } 
        }
        
        popolaMenuDate(); 
        document.getElementById('targetInput').value = db.target > 0 ? db.target : ""; 
        calcola();
    </script>
</body>
</html>
