<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rider Tracker Pro</title>
    <style>
        body { background: #121212; color: #eee; font-family: sans-serif; margin: 0; padding: env(safe-area-inset-top) 8px 10px 8px; }
        .card { background: #1e1e1e; padding: 12px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        h3 { color: #00CCBC; margin: 0 0 10px 0; text-align: center; font-size: 13px; text-transform: uppercase; }
        .row-single { display: flex; justify-content: space-between; align-items: center; text-align: center; gap: 2px; }
        .row-single div { flex: 1; min-width: 0; }
        input, select { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; border-top: 1px solid #333; padding-top: 12px; margin-top: 15px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-add { background: #00CCBC; color: #000; }
        .btn-fuel { background: #ffa500; color: #000; }
        .btn-del { width: auto; padding: 6px 10px; background: #ff4444; color: white; font-size: 10px; border:none; border-radius:4px; }
        .stat-val { font-size: 13px; font-weight: bold; color: #fff; display: inline-block; }
        .stat-label { font-size: 7px; color: #aaa; text-transform: uppercase; display: block; margin-bottom: 2px; }
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; font-weight: bold; border: 1px solid #00CCBC; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 1.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .target-box { background: #2a2a2a; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #555; }
        .session-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #00CCBC; font-size: 13px; position: relative; }
        .tag-netto { background: #00CCBC; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }
    </style>
</head>
<body>
    <div id="toast"></div>
    <div class="card">
        <h3>ðŸ“Š Riepilogo AttivitÃ </h3>
        <div class="row-single">
            <div><span class="stat-label">Lordo</span><span class="stat-val" style="color:#00CCBC">â‚¬ <span id="lordoTotale">0.00</span></span></div>
            <div><span class="stat-label">Netto</span><span class="stat-val">â‚¬ <span id="nettoReale">0.00</span></span></div>
            <div><span class="stat-label">Benza</span><span class="stat-val" style="color:#ff4444">â‚¬ <span id="costoBenzaTot">0.00</span></span></div>
            <div><span class="stat-label">Litri</span><span class="stat-val"><span id="litriTot">0.0</span> L</span></div>
        </div>
        <div class="target-box">
            <label class="stat-label">ðŸŽ¯ TARGET NETTO (â‚¬)</label>
            <input type="number" id="targetInput" oninput="salvaTarget()" style="margin-top:5px; padding:8px;">
            <div class="row-single" style="margin-top:5px;">
                <div style="text-align:left;"><span class="stat-label">Lordo da fare:</span><span class="stat-val" style="color:#ff4444; font-size: 14px;">â‚¬ <span id="lordoMancante">0.00</span></span></div>
                <div style="text-align:right;"><span class="stat-label">Progresso</span><span id="progressoPerc" class="stat-val" style="font-size: 14px;">0%</span></div>
            </div>
        </div>
        <div class="grid-triple">
            <div><span class="stat-label">Ore Lavoro</span><br><span id="oreTotali" class="stat-val">0.0</span></div>
            <div><span class="stat-label">Netto/Ora</span><br><span class="stat-val" style="color:#00CCBC">â‚¬ <span id="nettoOrario">0.00</span></span></div>
            <div><span class="stat-label">Media KM/L</span><br><span id="mediaKml" class="stat-val" style="color:#ffa500">0.0</span></div>
        </div>
    </div>

    <div class="card" style="border-color: #ffa50044;">
        <h3>â›½ Registra Rifornimento</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:10px;"><select id="fDay"></select><select id="fMonth"></select><select id="fYear"></select></div>
        <div class="grid"><input type="number" id="fuelEuro" placeholder="Euro â‚¬"><input type="number" id="fuelPrezzo" step="0.001" placeholder="â‚¬/l"></div>
        <button class="btn-fuel" onclick="aggiungiBenza()">SALVA BENZINA</button>
    </div>

    <div class="card" style="border-color: #00ccbc44;">
        <h3>âž• Registra Sessione</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:10px;"><select id="sDay"></select><select id="sMonth"></select><select id="sYear"></select></div>
        <div class="grid"><input type="number" id="sessKm" placeholder="Km Totali"><input type="number" id="sessScarto" placeholder="Scarto Km"></div>
        <div class="grid"><input type="number" id="sessLordo" step="0.01" placeholder="Lordo â‚¬"><input type="number" id="sessOre" step="0.1" placeholder="Ore Lavoro"></div>
        <input type="number" id="sessL100" step="0.1" placeholder="l/100 km (es. 4.0)">
        <button class="btn-add" onclick="aggiungiSessione()">SALVA SESSIONE</button>
    </div>

    <div id="storico"></div>
    <button onclick="resettutto()" style="background:#333; color:#888; padding:10px; font-size:10px; margin-top:20px; width:100%; border-radius:8px; border:none;">RESET TUTTI I DATI</button>

    <script>
        let db = JSON.parse(localStorage.getItem('rider_pro_v36')) || { sessioni: [], rifornimenti: [], target: 500 };
        function showToast(msg) { let x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 2000); }
        function popolaMenuDate() {
            const giorni = [document.getElementById('fDay'), document.getElementById('sDay')], mesi = [document.getElementById('fMonth'), document.getElementById('sMonth')], anni = [document.getElementById('fYear'), document.getElementById('sYear')], d = new Date();
            giorni.forEach(sel => { for(let i=1; i<=31; i++) sel.innerHTML += `<option value="${i}" ${i==d.getDate()?'selected':''}>${i}</option>`; });
            mesi.forEach(sel => { for(let i=1; i<=12; i++) sel.innerHTML += `<option value="${i}" ${i==(d.getMonth()+1)?'selected':''}>${i}</option>`; });
            anni.forEach(sel => { for(let i=2025; i<=2040; i++) sel.innerHTML += `<option value="${i}">${i}</option>`; });
        }
        function salvaTarget() { db.target = parseFloat(document.getElementById('targetInput').value) || 0; salva(); }
        function creaDataISO(prefix) { return document.getElementById(prefix+'Year').value + "-" + document.getElementById(prefix+'Month').value.padStart(2,'0') + "-" + document.getElementById(prefix+'Day').value.padStart(2,'0'); }
        function aggiungiBenza() {
            let e = parseFloat(document.getElementById('fuelEuro').value), p = parseFloat(document.getElementById('fuelPrezzo').value);
            if(e > 0 && p > 0) { db.rifornimenti.push({ id: Date.now(), data: creaDataISO('f'), euro: e, prezzo: p }); salva(); document.getElementById('fuelEuro').value = ""; showToast("âœ… Rifornimento salvato!"); }
        }
        function aggiungiSessione() {
            let km = parseFloat(document.getElementById('sessKm').value) || 0, scarto = parseFloat(document.getElementById('sessScarto').value) || 0, ore = parseFloat(document.getElementById('sessOre').value) || 0, lordo = parseFloat(document.getElementById('sessLordo').value) || 0, l100 = parseFloat(document.getElementById('sessL100').value) || 0;
            if(lordo > 0 || km > 0) { db.sessioni.push({ id: Date.now(), data: creaDataISO('s'), km, scarto, ore, lordo, l100 }); salva(); document.getElementById('sessKm').value = ""; document.getElementById('sessScarto').value = ""; document.getElementById('sessOre').value = ""; document.getElementById('sessLordo').value = ""; document.getElementById('sessL100').value = ""; showToast("âœ… Sessione salvata!"); }
        }
        function salva() { localStorage.setItem('rider_pro_v36', JSON.stringify(db)); calcola(); }
        function calcola() {
            let totLordo = db.sessioni.reduce((acc, s) => acc + s.lordo, 0), totOre = db.sessioni.reduce((acc, s) => acc + s.ore, 0), ultimoP = db.rifornimenti.length > 0 ? db.rifornimenti[db.rifornimenti.length-1].prezzo : 1.85;
            let litriT = 0, costoB = db.sessioni.reduce((acc, s) => {
                let kmL = Math.max(0, s.km - s.scarto);
                let l = (kmL / 100) * s.l100; litriT += l; return acc + (l * ultimoP);
            }, 0);
            let nettoA = (totLordo * 0.8) - costoB, mancanoN = Math.max(0, db.target - nettoA);
            document.getElementById('lordoTotale').innerText = totLordo.toFixed(2);
            document.getElementById('nettoReale').innerText = nettoA.toFixed(2);
            document.getElementById('costoBenzaTot').innerText = costoB.toFixed(2);
            document.getElementById('litriTot').innerText = litriT.toFixed(1);
            document.getElementById('oreTotali').innerText = totOre.toFixed(1);
            document.getElementById('nettoOrario').innerText = totOre > 0 ? (nettoA / totOre).toFixed(2) : "0.00";
            document.getElementById('mediaKml').innerText = db.sessioni.length > 0 && db.sessioni[db.sessioni.length-1].l100 > 0 ? (100 / db.sessioni[db.sessioni.length-1].l100).toFixed(1) : "0.0";
            document.getElementById('progressoPerc').innerText = db.target > 0 ? Math.round((nettoA / db.target) * 100) + "%" : "0%";
            document.getElementById('lordoMancante').innerText = (mancanoN * 1.25).toFixed(2);
            renderStorico(ultimoP);
        }
        function renderStorico(uP) {
            let h = "<h3>ðŸ“œ Storico</h3>", tutti = [...db.sessioni.map(s => ({...s, tipo: 'S'})), ...db.rifornimenti.map(r => ({...r, tipo: 'B'}))];
            tutti.sort((a,b) => new Date(a.data) - new Date(b.data)).reverse().forEach(item => {
                let d = item.data.split("-"), dIT = d[2]+"/"+d[1]+"/"+d[0];
                if(item.tipo === 'S') {
                    let kmL = Math.max(0, item.km - item.scarto), nS = (item.lordo * 0.8) - ((kmL / 100) * item.l100 * uP);
                    h += `<div class="session-item"><span style="color:#888">${dIT}</span><br><b style="color:#00CCBC">Lordo: â‚¬ ${item.lordo.toFixed(2)}</b> <span class="tag-netto">Netto: â‚¬ ${nS.toFixed(2)}</span><br><b>Ore: ${item.ore}h</b> | Lavoro: ${kmL}km <span style="font-size:10px; color:#666;">(Tot: ${item.km})</span><button class="btn-del" onclick="elimina('sessioni', ${item.id})" style="position:absolute; right:10px; top:12px;">X</button></div>`;
                } else {
                    h += `<div class="session-item" style="border-left-color: #ffa500; background: #2a2212;"><span style="color:#888">${dIT}</span> | â›½ <b>RIFORNIMENTO â‚¬ ${item.euro.toFixed(2)}</b><button class="btn-del" onclick="elimina('rifornimenti', ${item.id})" style="position:absolute; right:10px; top:12px;">X</button></div>`;
                }
            });
            document.getElementById('storico').innerHTML = h;
        }
        function elimina(t, id) { if(confirm("Eliminare?")) { db[t] = db[t].filter(i => i.id !== id); salva(); } }
        function resettutto() { if(confirm("Cancellare tutto?")) { localStorage.clear(); location.reload(); } }
        popolaMenuDate(); document.getElementById('targetInput').value = db.target; calcola();
    </script>
</body>
</html>
