<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rider Tracker Pro</title>
    <style>
        body { background: #121212; color: #eee; font-family: sans-serif; margin: 0; padding: env(safe-area-inset-top) 4px 5px 4px; overflow-x: hidden; width: 100vw; }
        .card { background: #1e1e1e; padding: 4px; border-radius: 8px; border: 1px solid #333; margin-bottom: 4px; box-sizing: border-box; width: 100%; }
        
        .main-title { color: #00CCBC; margin: 2px 0 6px 0; text-align: center; font-size: 15px; text-transform: uppercase; letter-spacing: 1px; font-weight: 900; }
        
        /* TITOLI SEZIONI COMPATTI */
        .section-title { color: #00CCBC; margin: 0 0 4px 0; text-align: center; font-size: 11px; text-transform: uppercase; font-weight: 800; display: block; line-height: 1.2; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
        .data-box { background: #252525; padding: 1px; border-radius: 5px; border: 1px solid #333; text-align: center; min-height: 30px; display: flex; flex-direction: column; justify-content: center; }
        
        .stat-label { font-size: 7px; color: #aaa; text-transform: uppercase; font-weight: 600; }
        .stat-val { font-size: 11px; font-weight: bold; color: #fff; line-height: 1; }

        input, select { 
            height: 30px; 
            background: #2a2a2a; 
            border: 1px solid #444; 
            color: white; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 13px; 
            text-align: center;
            -webkit-appearance: none;
            margin: 0;
            padding: 0 3px;
        }

        .compact-row { display: flex; gap: 3px; align-items: stretch; margin-bottom: 3px; width: 100%; }
        .date-group { display: flex; gap: 2px; }
        .sel-small { width: 35px; }
        .sel-year { width: 50px; }
        
        .input-group-fill { display: flex; gap: 3px; flex: 1; }
        .input-group-fill input { flex: 1; min-width: 0; }

        .grid-compact { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 3px; margin-bottom: 3px; }

        .progress-container { width: 100%; background: #1a1a1a; border-radius: 8px; height: 20px; margin: 4px 0 2px 0; position: relative; overflow: hidden; border: 1px solid #333; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.8s; background: linear-gradient(90deg, #ff4444, #00CCBC); }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 9px; font-weight: 900; color: #fff; text-shadow: 1px 1px 1px #000; z-index: 2; }

        button { width: 100%; height: 34px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 11px; }
        .btn-add { background: #00CCBC; color: #000; }
        .btn-fuel { background: #ffa500; color: #000; }
        .btn-del { width: auto; height: 20px; padding: 0 6px; background: #ff4444; color: white; font-size: 8px; border:none; border-radius:3px; }
        .btn-reset-all { background: #600; color: #fcc; margin-top: 10px; height: 30px; font-size: 10px; }

        .target-box { margin-top: 4px; background: #222; padding: 4px; border-radius: 8px; border: 1px solid #333; }
        .target-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
        .target-item { background: #2a2a2a; padding: 2px; border-radius: 5px; border: 1px solid #444; text-align: center; min-height: 40px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .target-input-field { background: transparent !important; border: 1px solid #00CCBC !important; color: #fff; width: 80%; height: 18px !important; border-radius: 3px; font-weight: bold; font-size: 12px; }
        
        .session-item { background: #252525; padding: 5px 8px; border-radius: 6px; margin-bottom: 4px; border-left: 3px solid #00CCBC; position: relative; font-size: 10px; }
        .history-date { color: #888; font-size: 8px; font-weight: bold; margin-bottom: 1px; display: block; }
        .tag-netto { background: #00CCBC; color: #000; padding: 0px 3px; border-radius: 2px; font-weight: bold; margin-left: 3px; }
        .footer-credits { text-align: center; padding: 10px 10px 30px 10px; color: #444; font-size: 9px; font-style: italic; }

        #toast { visibility: hidden; min-width: 120px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 6px; position: fixed; z-index: 3000; left: 50%; bottom: 15px; transform: translateX(-50%); border: 1px solid #00CCBC; font-size: 10px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 1.5s; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #252525; padding: 12px; border-radius: 10px; border: 1px solid #ff4444; width: 100%; max-width: 250px; text-align: center; }
        .modal-buttons { display: flex; gap: 6px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <div style="color:#ff4444; font-weight:bold; margin-bottom:5px; font-size:13px;">‚ö†Ô∏è ATTENZIONE</div>
            <div style="font-size:11px;">Eliminare tutti i dati?</div>
            <div class="modal-buttons">
                <button style="background:#444; color:#fff; height:30px;" onclick="chiudiModal()">Annulla</button>
                <button style="background:#ff4444; color:#fff; height:30px;" onclick="confermaReset()">OK</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <div class="card">
        <div class="main-title">üöÄ RIDER TRACKER PRO</div>
        <div class="summary-grid">
            <div class="data-box"><span class="stat-label">Lordo</span><span class="stat-val" style="color:#00CCBC">‚Ç¨ <span id="lordoTotale">0.00</span></span></div>
            <div class="data-box"><span class="stat-label">Netto</span><span class="stat-val">‚Ç¨ <span id="nettoReale">0.00</span></span></div>
            <div class="data-box"><span class="stat-label">Benza</span><span class="stat-val" style="color:#ff4444">‚Ç¨ <span id="costoBenzaTot">0.00</span></span></div>
            <div class="data-box"><span class="stat-label">Litri</span><span class="stat-val"><span id="litriTot">0.0</span> L</span></div>
            <div class="data-box"><span class="stat-label">KM Lav.</span><span id="kmLavoroTot" class="stat-val" style="color:#00CCBC">0</span></div>
            <div class="data-box"><span class="stat-label">KM Tot.</span><span id="kmAssoluti" class="stat-val" style="color:#ffa500">0</span></div>
            <div class="data-box"><span class="stat-label">Ore</span><span id="oreTotali" class="stat-val">0.0</span></div>
            <div class="data-box"><span class="stat-label">KM/L</span><span id="mediaKml" class="stat-val" style="color:#ffa500">0.0</span></div>
            <div class="data-box"><span class="stat-label">Netto/H</span><span class="stat-val" style="color:#00CCBC">‚Ç¨ <span id="nettoOrario">0.00</span></span></div>
        </div>

        <div class="target-box">
            <div class="target-grid">
                <div class="target-item"><span class="stat-label">TARGET</span><input type="number" id="targetInput" class="target-input-field" oninput="salvaTarget()" placeholder="0"></div>
                <div class="target-item" style="border-color:#ff444455;"><span class="stat-label">LORDO REQ.</span><span class="stat-val" style="color:#ff4444; font-size:10px;">‚Ç¨ <span id="lordoMancante">0.00</span></span></div>
                <div class="target-item" style="border-color:#00CCBC55;"><span class="stat-label">GG LAV.</span><span id="giorniLavorati" class="stat-val" style="color:#00CCBC; font-size:12px;">0</span></div>
            </div>
            <div class="progress-container">
                <div id="pBar" class="progress-bar"></div>
                <div id="progressoPerc" class="progress-text">0%</div>
            </div>
        </div>
    </div>

    <div class="card" style="border-color: #ffa50044;">
        <span class="section-title" style="color: #ffa500;">‚õΩ RIFORNIMENTO</span>
        <div class="compact-row">
            <div class="date-group">
                <select id="fDay" class="sel-small"></select>
                <select id="fMonth" class="sel-small"></select>
                <select id="fYear" class="sel-year"></select>
            </div>
            <div class="input-group-fill">
                <input type="number" id="fuelEuro" placeholder="‚Ç¨">
                <input type="number" id="fuelPrezzo" step="0.001" placeholder="‚Ç¨/l">
            </div>
        </div>
        <button class="btn-fuel" onclick="aggiungiBenza()" style="height:32px;">SALVA RIFORNIMENTO</button>
    </div>

    <div class="card" style="border-color: #00ccbc44;">
        <span class="section-title">‚ûï SESSIONE</span>
        <div class="compact-row">
            <div class="date-group">
                <select id="sDay" class="sel-small"></select>
                <select id="sMonth" class="sel-small"></select>
                <select id="sYear" class="sel-year"></select>
            </div>
            <div class="input-group-fill">
                <input type="number" id="sessLordo" step="0.01" placeholder="Lordo ‚Ç¨">
                <input type="number" id="sessOre" step="0.1" placeholder="Ore">
            </div>
        </div>
        <div class="grid-compact">
            <input type="number" id="sessKm" placeholder="Km Tot">
            <input type="number" id="sessScarto" placeholder="Scarto">
            <input type="number" id="sessL100" step="0.1" placeholder="l/100 km">
        </div>
        <button class="btn-add" onclick="aggiungiSessione()" style="height:32px;">SALVA SESSIONE</button>
    </div>

    <div id="storico"></div>
    <button class="btn-reset-all" onclick="apriModal()">‚ö†Ô∏è AZZERA DATI</button>
    <div class="footer-credits">Rider Tracker V. 1.0 - by Marco Carbone</div>

    <script>
        let db = JSON.parse(localStorage.getItem('rider_pro_v80')) || { sessioni: [], rifornimenti: [], target: 0 };
        function showToast(msg) { let x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = ""; }, 2000); }
        function apriModal() { document.getElementById('customModal').style.display = 'flex'; }
        function chiudiModal() { document.getElementById('customModal').style.display = 'none'; }
        function confermaReset() { db = { sessioni: [], rifornimenti: [], target: 0 }; localStorage.setItem('rider_pro_v80', JSON.stringify(db)); document.getElementById('targetInput').value = ""; popolaMenuDate(); calcola(); chiudiModal(); showToast("üóëÔ∏è Reset!"); }
        
        function popolaMenuDate() {
            const d = new Date();
            const g = [document.getElementById('fDay'), document.getElementById('sDay')], m = [document.getElementById('fMonth'), document.getElementById('sMonth')], a = [document.getElementById('fYear'), document.getElementById('sYear')];
            g.forEach(s => { s.innerHTML = ""; for(let i=1; i<=31; i++) s.innerHTML += `<option value="${i}" ${i==d.getDate()?'selected':''}>${i}</option>`; });
            m.forEach(s => { s.innerHTML = ""; for(let i=1; i<=12; i++) s.innerHTML += `<option value="${i}" ${i==(d.getMonth()+1)?'selected':''}>${i}</option>`; });
            a.forEach(s => { s.innerHTML = ""; for(let i=2025; i<=2028; i++) s.innerHTML += `<option value="${i}" ${i==d.getFullYear()?'selected':''}>${i}</option>`; });
        }

        function salvaTarget() { db.target = parseFloat(document.getElementById('targetInput').value) || 0; salva(); }
        function creaDataISO(p) { return document.getElementById(p+'Year').value + "-" + document.getElementById(p+'Month').value.padStart(2,'0') + "-" + document.getElementById(p+'Day').value.padStart(2,'0'); }
        function aggiungiBenza() {
            let e = parseFloat(document.getElementById('fuelEuro').value), p = parseFloat(document.getElementById('fuelPrezzo').value);
            if(e > 0 && p > 0) { db.rifornimenti.push({ id: Date.now(), data: creaDataISO('f'), euro: e, prezzo: p }); salva(); document.getElementById('fuelEuro').value = ""; document.getElementById('fuelPrezzo').value = ""; showToast("‚úÖ Benzinata!"); }
        }
        function aggiungiSessione() {
            let km = parseFloat(document.getElementById('sessKm').value) || 0, s = parseFloat(document.getElementById('sessScarto').value) || 0, o = parseFloat(document.getElementById('sessOre').value) || 0, l = parseFloat(document.getElementById('sessLordo').value) || 0, c = parseFloat(document.getElementById('sessL100').value) || 0;
            if(l > 0 || km > 0) { db.sessioni.push({ id: Date.now(), data: creaDataISO('s'), km, scarto: s, ore: o, lordo: l, l100: c }); salva(); 
                ['sessKm','sessScarto','sessOre','sessLordo','sessL100'].forEach(id => document.getElementById(id).value = "");
                showToast("‚úÖ Sessione!"); 
            }
        }
        function salva() { localStorage.setItem('rider_pro_v80', JSON.stringify(db)); calcola(); }
        function calcola() {
            let totL = db.sessioni.reduce((acc, s) => acc + s.lordo, 0), totO = db.sessioni.reduce((acc, s) => acc + s.ore, 0), uP = db.rifornimenti.length > 0 ? db.rifornimenti[db.rifornimenti.length-1].prezzo : 1.85;
            let kmLav = db.sessioni.reduce((acc, s) => acc + Math.max(0, s.km - s.scarto), 0);
            let gUnici = [...new Set(db.sessioni.map(s => s.data))].length;
            let litriT = 0, costoB = db.sessioni.reduce((acc, s) => { let k = Math.max(0, s.km - s.scarto); let lt = (k / 100) * s.l100; litriT += lt; return acc + (lt * uP); }, 0);
            let nA = (totL * 0.8) - costoB, mancN = Math.max(0, db.target - nA), perc = db.target > 0 ? Math.min(100, Math.round((nA / db.target) * 100)) : 0;
            
            document.getElementById('pBar').style.width = perc + "%";
            document.getElementById('progressoPerc').innerText = perc >= 100 ? "OBIETTIVO COMPLETATO! üéâ" : perc + "%";
            
            document.getElementById('giorniLavorati').innerText = gUnici;
            document.getElementById('lordoMancante').innerText = (mancN * 1.25).toFixed(2);
            document.getElementById('lordoTotale').innerText = totL.toFixed(2); document.getElementById('nettoReale').innerText = nA.toFixed(2);
            document.getElementById('costoBenzaTot').innerText = costoB.toFixed(2); document.getElementById('litriTot').innerText = litriT.toFixed(1);
            document.getElementById('kmAssoluti').innerText = db.sessioni.reduce((acc, s) => acc + s.km, 0); 
            document.getElementById('kmLavoroTot').innerText = kmLav;
            document.getElementById('oreTotali').innerText = totO.toFixed(1); document.getElementById('nettoOrario').innerText = totO > 0 ? (nA / totO).toFixed(2) : "0.00";
            document.getElementById('mediaKml').innerText = db.sessioni.length > 0 && db.sessioni[db.sessioni.length-1].l100 > 0 ? (100 / db.sessioni[db.sessioni.length-1].l100).toFixed(1) : "0.0";
            renderStorico(uP);
        }
        function renderStorico(uP) {
            let h = "<span class='section-title' style='margin-top:5px;'>üìú STORICO</span>", tutti = [...db.sessioni.map(s => ({...s, tipo: 'S'})), ...db.rifornimenti.map(r => ({...r, tipo: 'B'}))];
            tutti.sort((a,b) => new Date(a.data) - new Date(b.data)).reverse().forEach(item => {
                let d = item.data.split("-"), dIT = d[2]+"/"+d[1]+"/"+d[0];
                if(item.tipo === 'S') {
                    let kmL = Math.max(0, item.km - item.scarto), nS = (item.lordo * 0.8) - ((kmL / 100) * item.l100 * uP);
                    h += `<div class="session-item"><span class="history-date">${dIT} - SESSIONE</span>
                         <span>Lordo: <b>‚Ç¨ ${item.lordo.toFixed(2)}</b> <span class="tag-netto">Netto: ‚Ç¨ ${nS.toFixed(2)}</span></span>
                         <button class="btn-del" onclick="elimina('sessioni', ${item.id})" style="position:absolute; right:8px; top:5px;">ELIMINA</button></div>`;
                } else {
                    h += `<div class="session-item" style="border-left-color: #ffa500;"><span class="history-date">${dIT} - BENZA</span>
                         <span>Spesa: <b>‚Ç¨ ${item.euro.toFixed(2)}</b></span>
                         <button class="btn-del" onclick="elimina('rifornimenti', ${item.id})" style="position:absolute; right:8px; top:5px;">ELIMINA</button></div>`;
                }
            });
            document.getElementById('storico').innerHTML = h;
        }
        function elimina(t, id) { if(confirm("Eliminare?")) { db[t] = db[t].filter(i => i.id !== id); salva(); } }
        popolaMenuDate(); calcola();
        document.getElementById('targetInput').value = db.target > 0 ? db.target : "";
    </script>
</body>
</html>
