<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rider Tracker Pro V1.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* TUA GRAFICA ORIGINALE INALTERATA */
        :root { --p-orange: #ff9800; --p-black: #121212; --p-grey: #1e1e1e; --p-white: #e0e0e0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--p-black); color: var(--p-white); margin: 0; padding: 10px; }
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { background: var(--p-grey); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #333; }
        .card label { font-size: 0.7rem; color: var(--p-orange); display: block; margin-bottom: 5px; }
        .card span { font-size: 1.1rem; font-weight: bold; }
        .card input { width: 90%; background: transparent; border: none; border-bottom: 2px solid var(--p-orange); color: white; text-align: center; font-size: 1.1rem; outline: none; }
        .btn-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-plus { background: var(--p-orange); color: black; }
        .btn-fuel { background: #444; color: white; border: 1px solid var(--p-orange); }
        .btn-reset { background: #b71c1c; color: white; width: 100%; margin-top: 10px; }
        .form-window { position: fixed; bottom: 0; left: 0; width: 100%; background: #222; border-top: 3px solid var(--p-orange); border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; display: none; z-index: 1500; }
        
        /* AGGIUNTA SOLO STILE MODALE PROFESSIONALE */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: var(--p-grey); border: 2px solid var(--p-orange); border-radius: 20px; padding: 25px; width: 85%; max-width: 380px; text-align: center; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-ok { background: var(--p-orange); color: #000; }
        .btn-cancel { background: #333; color: #fff; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="card"><label>Lordo</label><span id="disp-lordo">0.00</span>€</div>
        <div class="card"><label>Netto</label><span id="disp-netto" style="color:var(--p-orange)">0.00</span>€</div>
        <div class="card"><label>Ore</label><span id="disp-ore">0</span></div>
        <div class="card"><label>Litri Stim.</label><span id="disp-litri">0.0</span></div>
        <div class="card"><label>KM/L</label><span id="disp-kml">0.0</span></div>
        <div class="card"><label>Spesa Benz.</label><span id="disp-benz">0.00</span>€</div>
        <div class="card"><label>Target Netto</label><input type="number" id="input-target" oninput="salvaDB()"></div>
        <div class="card"><label>Tax %</label><input type="number" id="input-tax" oninput="salvaDB()"></div>
        <div class="card"><label>Mancante</label><span id="disp-mancante">0.00</span>€</div>
    </div>

    <div class="btn-container">
        <button class="btn btn-plus" onclick="apriForm('turno')">+ TURNO</button>
        <button class="btn btn-fuel" onclick="apriForm('benzina')">⛽ BENZINA</button>
    </div>
    <button class="btn btn-reset" onclick="confermaAzzera()">AZZERA DATABASE</button>

    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" style="color:var(--p-orange); margin-top:0">AVVISO</h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalCancelBtn" class="btn-modal btn-cancel">ANNULLA</button>
                <button id="modalConfirmBtn" class="btn-modal btn-ok">OK</button>
            </div>
        </div>
    </div>
    <script>
        let db = JSON.parse(localStorage.getItem('rider_db_final_v30')) || { turni: [], benzina: [], target: 0, tax: 20 };
        let modalCallback = null;

        // Gestione Nuove Modali Professionali
        function mostraModale(titolo, messaggio, callback = null, mostraAnnulla = false) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerText = titolo;
            document.getElementById('modalMessage').innerText = messaggio;
            document.getElementById('modalCancelBtn').style.display = mostraAnnulla ? 'block' : 'none';
            modal.style.display = 'flex';
            modalCallback = callback;
        }

        document.getElementById('modalConfirmBtn').onclick = () => {
            document.getElementById('customModal').style.display = 'none';
            if (modalCallback) modalCallback();
        };

        document.getElementById('modalCancelBtn').onclick = () => {
            document.getElementById('customModal').style.display = 'none';
            modalCallback = null;
        };

        // Funzioni originali di calcolo e salvataggio
        function salvaDB() {
            db.target = parseFloat(document.getElementById('input-target').value) || 0;
            db.tax = parseFloat(document.getElementById('input-tax').value) || 20;
            localStorage.setItem('rider_db_final_v30', JSON.stringify(db));
            calcola();
        }

        function confermaAzzera() {
            // Sostituito confirm() con mostraModale()
            mostraModale("ATTENZIONE", "Vuoi azzerare tutto il database? L'azione non è reversibile.", () => {
                localStorage.removeItem('rider_db_final_v30');
                location.reload();
            }, true);
        }

        function calcola() {
            let lordoTot = 0, oreTot = 0, kmTot = 0, litriStim = 0;
            db.turni.forEach(t => {
                lordoTot += t.lordo; oreTot += t.ore; kmTot += t.km;
                litriStim += (t.km * t.cons) / 100;
            });
            let spesaB = db.benzina.reduce((a, b) => a + b.euro, 0);
            let ultimoP = db.benzina.length > 0 ? db.benzina[db.benzina.length-1].prezzo : 1.80;
            let costoB = litriStim * ultimoP;
            let netto = lordoTot - (lordoTot * db.tax / 100) - costoB;
            let mancanteN = db.target - netto;
            let mancanteL = mancanteN > 0 ? mancanteN / (1 - (db.tax/100)) : 0;

            document.getElementById('disp-lordo').innerText = lordoTot.toFixed(2);
            document.getElementById('disp-netto').innerText = netto.toFixed(2);
            document.getElementById('disp-ore').innerText = oreTot;
            document.getElementById('disp-litri').innerText = litriStim.toFixed(1);
            document.getElementById('disp-kml').innerText = litriStim > 0 ? (kmTot/litriStim).toFixed(1) : "0.0";
            document.getElementById('disp-benz').innerText = spesaB.toFixed(2);
            document.getElementById('disp-mancante').innerText = mancanteL.toFixed(2);
        }

        window.onload = () => {
            document.getElementById('input-target').value = db.target;
            document.getElementById('input-tax').value = db.tax;
            
            // Pop-up allerta fine mese professionale
            if (new Date().getDate() === 1) {
                mostraModale("AVVISO FINE MESE", "È il primo del mese! Genera il PDF prima di azzerare i dati.");
            }
            calcola();
        };

        // ... Inserisci qui le tue restanti funzioni originali (apriForm, aggiungiTurno, ecc.)
    </script>
</body>
</html>
