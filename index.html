<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rider Tracker Pro</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">

    <style>
        body { background: #121212; color: #eee; font-family: sans-serif; margin: 0; padding: env(safe-area-inset-top) 10px 10px 10px; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        h3 { color: #00CCBC; margin: 0 0 10px 0; text-align: center; font-size: 14px; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; border-top: 1px solid #333; padding-top: 12px; margin-top: 15px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-add { background: #00CCBC; color: #000; }
        .btn-fuel { background: #ffa500; color: #000; }
        .btn-del { width: auto; padding: 6px 10px; background: #ff4444; color: white; font-size: 10px; border:none; border-radius:4px; }
        .stat-val { font-size: 15px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 9px; color: #aaa; text-transform: uppercase; }
        .target-box { background: #2a2a2a; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #555; }
        .session-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #00CCBC; font-size: 13px; position: relative; }
        .tag-netto { background: #00CCBC; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .scarto-label { color: #ff4444; font-size: 10px; font-weight: bold; }
    </style>
</head>

<body>

<div class="card">
    <h3>ðŸ“Š Riepilogo AttivitÃ </h3>
    <div class="grid">
        <div><span class="stat-label">Netto Reale (-Benza)</span><br><span id="nettoReale" class="stat-val">0.00</span> â‚¬</div>
        <div><span class="stat-label">Progresso</span><br><span id="progressoPerc" class="stat-val" style="color:#00CCBC">0%</span></div>
    </div>

    <div class="target-box">
        <label class="stat-label">ðŸŽ¯ TARGET NETTO (â‚¬)</label>
        <input type="number" id="targetInput" oninput="salvaTarget()">
        <div>
            <span class="stat-label">Lordo da fare</span><br>
            <span id="lordoMancante" class="stat-val" style="color:#ff4444">0.00</span> â‚¬
        </div>
    </div>

    <div class="grid-triple">
        <div><span class="stat-label">Ore</span><br><span id="oreTotali" class="stat-val">0.0</span></div>
        <div><span class="stat-label">Netto/Ora</span><br><span id="nettoOrario" class="stat-val">0.00</span></div>
        <div><span class="stat-label">Km/L</span><br><span id="mediaKml" class="stat-val">0.0</span></div>
    </div>
</div>

<div id="storico"></div>

<script>
let db = JSON.parse(localStorage.getItem('rider_pro_v25')) || { sessioni: [], rifornimenti: [], target: 500 };

function salva() {
    localStorage.setItem('rider_pro_v25', JSON.stringify(db));
    calcola();
}

function salvaTarget() {
    db.target = parseFloat(targetInput.value) || 0;
    salva();
}

function calcola() {
    let totLordo = db.sessioni.reduce((a,s)=>a+s.lordo,0);
    let totOre = db.sessioni.reduce((a,s)=>a+s.ore,0);
    let prezzo = db.rifornimenti.at(-1)?.prezzo || 1.85;

    let costo = db.sessioni.reduce((a,s)=>{
        let km = Math.max(0, s.km - s.scarto);
        return a + ((km/100)*s.l100*prezzo);
    },0);

    let netto = (totLordo*0.8) - costo;
    nettoReale.innerText = netto.toFixed(2);
    oreTotali.innerText = totOre.toFixed(1);
    nettoOrario.innerText = totOre ? (netto/totOre).toFixed(2) : "0.00";
    progressoPerc.innerText = db.target ? Math.round((netto/db.target)*100)+"%" : "0%";
    lordoMancante.innerText = Math.max(0,(db.target-netto)*1.25).toFixed(2);
}

targetInput.value = db.target;
calcola();

/* PWA */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
