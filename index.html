<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rider Tracker Pro V1.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --p-orange: #ff9800; --p-black: #121212; --p-grey: #1e1e1e; --p-white: #e0e0e0; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--p-black); color: var(--p-white); margin: 0; padding: 10px; padding-bottom: 80px; overflow-x: hidden; }
        
        /* Dashboard Grid */
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { background: var(--p-grey); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card label { font-size: 0.7rem; color: var(--p-orange); text-transform: uppercase; display: block; margin-bottom: 5px; font-weight: bold; }
        .card span { font-size: 1.1rem; font-weight: bold; }
        .card input { width: 90%; background: transparent; border: none; border-bottom: 2px solid var(--p-orange); color: white; text-align: center; font-size: 1.1rem; font-weight: bold; outline: none; }

        /* Buttons */
        .btn-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-plus { background: var(--p-orange); color: black; }
        .btn-fuel { background: #444; color: white; border: 1px solid var(--p-orange); }
        .btn-reset { background: #b71c1c; color: white; margin-top: 10px; width: 100%; }

        /* Modali Professionali */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: var(--p-grey); border: 2px solid var(--p-orange); border-radius: 20px; padding: 25px; width: 85%; max-width: 380px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-ok { background: var(--p-orange); color: #000; }
        .btn-cancel { background: #333; color: #fff; }

        /* Form Finestre */
        .form-window { position: fixed; bottom: 0; left: 0; width: 100%; background: #222; border-top: 3px solid var(--p-orange); border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; display: none; z-index: 1500; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: var(--p-orange); font-size: 0.8rem; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 12px; background: #333; border: 1px solid #444; border-radius: 8px; color: white; font-size: 1rem; box-sizing: border-box; }
        
        .history-btn { background: #333; color: var(--p-orange); border: 1px solid var(--p-orange); width: 100%; padding: 12px; border-radius: 12px; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="card"><label>Lordo</label><span id="disp-lordo">0.00</span>â‚¬</div>
        <div class="card"><label>Netto</label><span id="disp-netto" style="color:var(--p-orange)">0.00</span>â‚¬</div>
        <div class="card"><label>Ore</label><span id="disp-ore">0</span></div>
        <div class="card"><label>Litri Stim.</label><span id="disp-litri">0.0</span></div>
        <div class="card"><label>KM/L</label><span id="disp-kml">0.0</span></div>
        <div class="card"><label>Spesa Benz.</label><span id="disp-benz">0.00</span>â‚¬</div>
        <div class="card"><label>Target Netto</label><input type="number" id="input-target" placeholder="0" oninput="salvaDB()"></div>
        <div class="card"><label>Tax %</label><input type="number" id="input-tax" value="20" oninput="salvaDB()"></div>
        <div class="card"><label>Mancante</label><span id="disp-mancante">0.00</span>â‚¬</div>
    </div>

    <div class="btn-container">
        <button class="btn btn-plus" onclick="apriForm('turno')"><span>+</span> TURNO</button>
        <button class="btn btn-fuel" onclick="apriForm('benzina')">â›½ BENZINA</button>
    </div>

    <button class="history-btn" onclick="mostraStorico()">ðŸ•’ STORICO E REPORT</button>
    <button class="btn btn-reset" onclick="confermaAzzera()">AZZERA DATABASE</button>

    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">AVVISO</h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalCancelBtn" class="btn-modal btn-cancel">ANNULLA</button>
                <button id="modalConfirmBtn" class="btn-modal btn-ok">OK</button>
            </div>
        </div>
    </div>

    <div id="form-turno" class="form-window">
        <h3 style="color:var(--p-orange); margin-top:0">Nuovo Turno</h3>
        <div class="form-group"><label>Data</label><input type="date" id="t-data"></div>
        <div class="form-group"><label>Lordo (â‚¬)</label><input type="number" id="t-lordo" step="0.01"></div>
        <div class="form-group"><label>Ore lavorate</label><input type="number" id="t-ore" step="0.1"></div>
        <div class="form-group"><label>KM percorsi</label><input type="number" id="t-km" step="0.1"></div>
        <div class="form-group"><label>Consumo L/100km</label><input type="number" id="t-cons" step="0.1"></div>
        <div class="btn-container">
            <button class="btn btn-fuel" onclick="chiudiForm('turno')">CHIUDI</button>
            <button class="btn btn-plus" onclick="aggiungiTurno()">SALVA</button>
        </div>
    </div>

    <div id="form-benzina" class="form-window">
        <h3 style="color:var(--p-orange); margin-top:0">Rifornimento</h3>
        <div class="form-group"><label>Euro spesi (â‚¬)</label><input type="number" id="b-euro" step="0.01"></div>
        <div class="form-group"><label>Prezzo al Litro (â‚¬/L)</label><input type="number" id="b-prezzo" step="0.001"></div>
        <div class="btn-container">
            <button class="btn btn-fuel" onclick="chiudiForm('benzina')">CHIUDI</button>
            <button class="btn btn-plus" onclick="aggiungiBenzina()">SALVA</button>
        </div>
    </div>
    <script>
        let db = JSON.parse(localStorage.getItem('rider_db_final_v30')) || { turni: [], benzina: [], target: 0, tax: 20 };
        let modalCallback = null;

        // Funzione Modale Professionale
        function mostraModale(titolo, messaggio, callback = null, mostraAnnulla = false) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerText = titolo;
            document.getElementById('modalMessage').innerText = messaggio;
            document.getElementById('modalCancelBtn').style.display = mostraAnnulla ? 'block' : 'none';
            modal.style.display = 'flex';
            modalCallback = callback;
        }

        document.getElementById('modalConfirmBtn').onclick = () => {
            document.getElementById('customModal').style.display = 'none';
            if (modalCallback) modalCallback();
        };

        document.getElementById('modalCancelBtn').onclick = () => {
            document.getElementById('customModal').style.display = 'none';
            modalCallback = null;
        };

        function apriForm(tipo) { document.getElementById('form-' + tipo).style.display = 'block'; }
        function chiudiForm(tipo) { document.getElementById('form-' + tipo).style.display = 'none'; }

        function aggiungiTurno() {
            const turno = {
                data: document.getElementById('t-data').value,
                lordo: parseFloat(document.getElementById('t-lordo').value) || 0,
                ore: parseFloat(document.getElementById('t-ore').value) || 0,
                km: parseFloat(document.getElementById('t-km').value) || 0,
                cons: parseFloat(document.getElementById('t-cons').value) || 0
            };
            if(turno.lordo > 0) {
                db.turni.push(turno);
                salvaDB();
                chiudiForm('turno');
                mostraModale("SUCCESSO", "Turno salvato correttamente!");
            }
        }

        function aggiungiBenzina() {
            const rif = {
                euro: parseFloat(document.getElementById('b-euro').value) || 0,
                prezzo: parseFloat(document.getElementById('b-prezzo').value) || 0,
                data: new Date().toLocaleDateString()
            };
            if(rif.euro > 0) {
                db.benzina.push(rif);
                salvaDB();
                chiudiForm('benzina');
                mostraModale("SUCCESSO", "Rifornimento registrato!");
            }
        }

        function salvaDB() {
            db.target = parseFloat(document.getElementById('input-target').value) || 0;
            db.tax = parseFloat(document.getElementById('input-tax').value) || 0;
            localStorage.setItem('rider_db_final_v30', JSON.stringify(db));
            calcola();
        }

        function calcola() {
            let lordoTot = 0, oreTot = 0, kmTot = 0, litriStimati = 0;
            db.turni.forEach(t => {
                lordoTot += t.lordo; oreTot += t.ore; kmTot += t.km;
                litriStimati += (t.km * t.cons) / 100;
            });

            let spesaBenzinaReale = db.benzina.reduce((acc, b) => acc + b.euro, 0);
            let ultimoPrezzoBenzina = db.benzina.length > 0 ? db.benzina[db.benzina.length-1].prezzo : 1.80;
            let costoBenzinaStimato = litriStimati * ultimoPrezzoBenzina;

            let netto = lordoTot - (lordoTot * db.tax / 100) - costoBenzinaStimato;
            let mancanteNetto = db.target - netto;
            let mancanteLordo = mancanteNetto > 0 ? mancanteNetto / (1 - (db.tax/100)) : 0;

            document.getElementById('disp-lordo').innerText = lordoTot.toFixed(2);
            document.getElementById('disp-netto').innerText = netto.toFixed(2);
            document.getElementById('disp-ore').innerText = oreTot;
            document.getElementById('disp-litri').innerText = litriStimati.toFixed(1);
            document.getElementById('disp-kml').innerText = litriStimati > 0 ? (kmTot / litriStimati).toFixed(1) : "0.0";
            document.getElementById('disp-benz').innerText = spesaBenzinaReale.toFixed(2);
            document.getElementById('disp-mancante').innerText = mancanteLordo.toFixed(2);
        }

        function confermaAzzera() {
            mostraModale("ATTENZIONE", "Vuoi davvero azzerare tutto il database e il target?", () => {
                localStorage.removeItem('rider_db_final_v30');
                location.reload();
            }, true);
        }

        // Auto-scroll logic
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('focusin', (e) => {
                setTimeout(() => { e.target.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300);
            });
        });

        window.onload = () => {
            document.getElementById('input-target').value = db.target;
            document.getElementById('input-tax').value = db.tax;
            if(new Date().getDate() === 1) mostraModale("FINE MESE", "Genera il report PDF prima di azzerare!");
            calcola();
        };
    </script>
</body>
</html>
