<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0f0f">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RIDER TRACKER PRO V1.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* === STILI ORIGINALI NON MODIFICATI === */
        :root { --bg:#0f0f0f; --card:#1a1a1a; --primary:#00CCBC; --accent:#ff4d4d; --text:#e0e0e0; --dim:#888; --input-bg:#252525; --orange:#ffa500; --red-soft:#8b0000; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action: manipulation; }
        body { font-family:sans-serif; background:var(--bg); color:var(--text); margin:0; padding:10px; text-align:center; overflow: hidden !important; height: 100%; width: 100vw; position: fixed; left:0; top:0; }
        /* (tutti gli altri stili identici ai tuoi, non toccati) */
    </style>
</head>

<body>
<div id="mainContainer">

    <!-- === TUTTO IL TUO HTML ORIGINALE È IDENTICO FINO A reportView === -->

    <div id="reportView">
        <div class="report-header-mini">
            <h2>REPORT ATTIVITÀ</h2>
            <span>RIDER TRACKER PRO V1.0</span>
        </div>

        <div class="report-section">
            <h3>DETTAGLIO TURNI</h3>
            <table class="report-table">
                <thead>
                <tr><th>DATA</th><th>LORDO</th><th>ORE</th><th>KM</th><th>L/100</th><th>LITRI</th></tr>
                </thead>
                <tbody id="repTurniBody"></tbody>
            </table>
        </div>

        <div class="report-section">
            <h3>DETTAGLIO RIFORNIMENTI</h3>
            <table class="report-table">
                <thead>
                <tr><th>DATA</th><th>SPESA</th><th>PREZZO/L</th><th>LITRI</th></tr>
                </thead>
                <tbody id="repBenzaBody"></tbody>
            </table>
        </div>

        <div class="report-section">
            <h3>RIEPILOGO FINALE</h3>
            <div class="summary-box" id="repFinalSummary"></div>
        </div>

        <div class="no-print" style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-modal btn-save" style="background:#000; color:#fff;" onclick="window.print()">STAMPA PDF</button>
            <button class="btn-modal btn-close" onclick="document.getElementById('reportView').style.display='none'">CHIUDI</button>
        </div>

        <!-- === BACKUP CONTROLS (AGGIUNTA) === -->
        <div class="no-print" style="margin-top:15px; border-top:1px dashed #000; padding-top:10px;">
            <div style="display:flex; gap:10px;">
                <button class="btn-modal btn-save" onclick="salvaBackup()">SALVA BACKUP</button>
                <button class="btn-modal btn-close" onclick="caricaBackup()">CARICA BACKUP</button>
            </div>
        </div>

        <!-- === CRONOLOGIA BACKUP (AGGIUNTA) === -->
        <div class="no-print" style="margin-top:15px;">
            <h3 style="font-size:13px; text-transform:uppercase;">CRONOLOGIA BACKUP</h3>
            <div id="backupHistory" style="border:1px solid #000; padding:8px; font-size:10px; max-height:160px; overflow-y:auto;">
                <div style="color:#777; text-align:center;">Nessun backup</div>
            </div>
        </div>

    </div>
</div>

<script>
/* === IL TUO JS ORIGINALE È IDENTICO E NON TOCCATO === */
</script>

<script>
/* ===== BACKUP & CRONOLOGIA (AGGIUNTA ISOLATA) ===== */

const BACKUP_KEY = "rider_backup_history";

function salvaBackup() {
    const backup = {
        app: "RIDER TRACKER PRO",
        version: APP_VER,
        created: new Date().toISOString(),
        data: db
    };

    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "rider_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);

    let history = JSON.parse(localStorage.getItem(BACKUP_KEY)) || [];
    history.unshift({ date: new Date().toLocaleString() });
    history = history.slice(0, 10);
    localStorage.setItem(BACKUP_KEY, JSON.stringify(history));

    aggiornaBackupHistory();
}

function caricaBackup() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";

    input.onchange = () => {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
            const json = JSON.parse(reader.result);
            if (!json.data) return alert("Backup non valido");

            if (!confirm("Questo backup sovrascriverà i dati attuali. Continuare?")) return;

            db = json.data;
            salvaDB();
            calcola();
            apriReport();
        };
        reader.readAsText(file);
    };
    input.click();
}

function aggiornaBackupHistory() {
    const box = document.getElementById("backupHistory");
    const history = JSON.parse(localStorage.getItem(BACKUP_KEY)) || [];
    if (!history.length) {
        box.innerHTML = "<div style='color:#777; text-align:center;'>Nessun backup</div>";
        return;
    }
    box.innerHTML = history.map(h =>
        `<div style="border-bottom:1px dashed #999; padding:4px 0;">${h.date}</div>`
    ).join("");
}

document.addEventListener("DOMContentLoaded", aggiornaBackupHistory);
</script>

</body>
</html>
