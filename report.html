<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Report Rider Tracker Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f0f0f; color: #e0e0e0; padding: 20px; text-align: center; }
        .btn-report { background: #00CCBC; color: #000; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin: 10px; }
        .btn-back { background: #333; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 20px; }
    </style>
</head>
<body>

    <h2>Generazione Report PDF</h2>
    <p>Clicca il pulsante qui sotto per scaricare il riepilogo dettagliato dei turni e dei rifornimenti.</p>
    
    <button class="btn-report" onclick="generatePDF()">SCARICA REPORT PDF</button>
    <br>
    <a href="index.html" class="btn-back">Torna all'App</a>

    <script>
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Recupero dati (stesso ID versione dell'app principale)
            const db = JSON.parse(localStorage.getItem('rider_db_v94v2')) || { s: [], r: [], target: 0, tax: 20 };

            // Titolo
            doc.setFontSize(18);
            doc.text("REPORT ATTIVITÀ RIDER TRACKER PRO", 14, 20);
            
            // --- TABELLA TURNI ---
            doc.setFontSize(14);
            doc.text("Dettaglio Turni", 14, 35);
            
            const turniRows = db.s.map(t => {
                let ltr = (t.k * (t.c / 100)).toFixed(2);
                let media = t.k > 0 ? (t.k / ltr).toFixed(1) : "0.0";
                return [
                    t.time || "N/D", // Qui riprendiamo la data salvata
                    "€" + t.l.toFixed(2),
                    t.o + "h",
                    t.k + " km",
                    ltr + " L",
                    media + " km/l"
                ];
            });

            doc.autoTable({
                startY: 40,
                head: [['Data/Ora', 'Lordo', 'Ore', 'KM', 'Consumo L', 'Media']],
                body: turniRows,
                theme: 'striped',
                headStyles: { fillColor: [0, 204, 188] }
            });

            // --- TABELLA RIFORNIMENTI ---
            let finalY = doc.lastAutoTable.finalY + 15;
            doc.text("Dettaglio Carburante", 14, finalY);
            
            const benzaRows = db.r.map(b => [
                b.time || "N/D", // Qui riprendiamo la data salvata
                "€" + b.e.toFixed(2),
                "€" + b.p.toFixed(3) + "/L"
            ]);

            doc.autoTable({
                startY: finalY + 5,
                head: [['Data/Ora Inserimento', 'Spesa (€)', 'Prezzo al Litro']],
                body: benzaRows,
                theme: 'striped',
                headStyles: { fillColor: [255, 165, 0] }
            });

            // --- RIEPILOGO FINALE ---
            let riepilogoY = doc.lastAutoTable.finalY + 15;
            let lordoTot = db.s.reduce((acc, curr) => acc + curr.l, 0);
            let oreTot = db.s.reduce((acc, curr) => acc + curr.o, 0);
            let kmTot = db.s.reduce((acc, curr) => acc + curr.k, 0);
            
            // Calcolo costo benzina basato sui turni
            let litriTot = 0;
            let costoBenzaTot = 0;
            db.s.forEach(t => {
                let ltr = (t.k * (t.c / 100));
                litriTot += ltr;
                let prezzo = db.r.length > 0 ? db.r[db.r.length - 1].p : 1.85;
                costoBenzaTot += (ltr * prezzo);
            });

            let tasseEuro = lordoTot * (db.tax / 100);
            let nettoTot = lordoTot - tasseEuro - costoBenzaTot;

            doc.setFontSize(14);
            doc.text("RIEPILOGO TOTALI", 14, riepilogoY);
            doc.setFontSize(10);
            doc.text(`Lordo Totale: €${lordoTot.toFixed(2)}`, 14, riepilogoY + 10);
            doc.text(`Tasse (${db.tax}%): €${tasseEuro.toFixed(2)}`, 14, riepilogoY + 17);
            doc.text(`Costo Benzina Totale: €${costoBenzaTot.toFixed(2)}`, 14, riepilogoY + 24);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`NETTO GUADAGNATO: €${nettoTot.toFixed(2)}`, 14, riepilogoY + 34);

            // Salvataggio
            doc.save(`Report_Rider_${new Date().toLocaleDateString()}.pdf`);
        }
    </script>
</body>
</html>
